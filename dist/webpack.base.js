'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _path=require('path');var _path2=_interopRequireDefault(_path);var _esWebpack=require('es-webpack');var _esWebpack2=_interopRequireDefault(_esWebpack);var _happypack=require('happypack');var _happypack2=_interopRequireDefault(_happypack);var _webpackMerge=require('webpack-merge');var _webpackMerge2=_interopRequireDefault(_webpackMerge);var _os=require('os');var _os2=_interopRequireDefault(_os);var _extractTextWebpackPlugin=require('extract-text-webpack-plugin');var _extractTextWebpackPlugin2=_interopRequireDefault(_extractTextWebpackPlugin);var _chunkManifestWebpackPlugin=require('chunk-manifest-webpack-plugin');var _chunkManifestWebpackPlugin2=_interopRequireDefault(_chunkManifestWebpackPlugin);var _optimizeModuleidAndChunkidPlugin=require('optimize-moduleid-and-chunkid-plugin');var _optimizeModuleidAndChunkidPlugin2=_interopRequireDefault(_optimizeModuleidAndChunkidPlugin);var _copyWebpackPlugin=require('copy-webpack-plugin');var _copyWebpackPlugin2=_interopRequireDefault(_copyWebpackPlugin);var _webpackBundleAnalyzer=require('webpack-bundle-analyzer');var _friendlyErrorsWebpackPlugin=require('friendly-errors-webpack-plugin');var _friendlyErrorsWebpackPlugin2=_interopRequireDefault(_friendlyErrorsWebpackPlugin);var _options=require('./config/options');var _options2=_interopRequireDefault(_options);var _entry=require('./config/entry');var entry=_interopRequireWildcard(_entry);var _loader=require('./config/loader');var loaders=_interopRequireWildcard(_loader);var _uglify=require('./config/uglify');var _uglify2=_interopRequireDefault(_uglify);var _utils=require('./utils');function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}// 基础配置
var config={output:Object.assign(_options2.default.output,{filename:'[name].js'}),externals:_options2.default.externals,resolve:{alias:entry.configAlias,extensions:['*','.js','.jsx']},module:{noParse:[],rules:[loaders.jsLoader({id:'babelJs'},[_options2.default.nodeModulesDir]),loaders.cssLoader({minimize:_options2.default.__DEV__||_options2.default.__DEBUG__?false:true}),loaders.lessLoader({minimize:_options2.default.__DEV__||_options2.default.__DEBUG__?false:true}),loaders.jsonLoader(),loaders.domLoader()]},plugins:[new _happypack2.default({id:'babelJs',threadPool:_happypack2.default.ThreadPool({size:_os2.default.cpus().length}),verbose:false,loaders:['babel-loader']}),new _extractTextWebpackPlugin2.default({filename:function filename(getPath){return getPath('[name].css').replace('js','css');},allChunks:true}),new _esWebpack2.default.DefinePlugin({'process.env':{'NODE_ENV':JSON.stringify(process.env.NODE_ENV||'development')}}),new _esWebpack2.default.ProvidePlugin(_options2.default.global),new _esWebpack2.default.ContextReplacementPlugin(/moment[\\\/]locale$/,/^\.\/(zh-cn|en-gb)+\.js$/),new _optimizeModuleidAndChunkidPlugin2.default(),new _esWebpack2.default.WatchIgnorePlugin(_options2.default.ignoredDirs)]};for(var key in _options2.default.noParseDeps){var depPath=_path2.default.resolve(_options2.default.nodeModulesDir,_options2.default.noParseDeps[key]);config.resolve.alias[key]=depPath;config.module.noParse.push(depPath);config.module.rules.push(loaders.importsLoader(config.module.noParse));}if(_options2.default.__DEV__){config.plugins=config.plugins.concat(new _friendlyErrorsWebpackPlugin2.default());_options2.default.isESlint?config.module.rules.push(loaders.eslintLoader()):'';}if(!_options2.default.__DEV__&&!_options2.default.__DEBUG__){config.plugins=config.plugins.concat(new _esWebpack2.default.optimize.UglifyJsPlugin(_uglify2.default));}else{config.devtool=_options2.default.__DEVTOOL__;}var minChunks=function minChunks(module,count){if(module.resource&&/^.*\.(css|less)$/.test(module.resource)){return false;}var pattern=new RegExp(_options2.default.regExp);return module.resource&&!pattern.test(module.resource)&&count>=_options2.default.minChunks;};// lib 配置
var libConfigs=[];if(_options2.default.isBuildAllModule){var libEntry=(0,_utils.filterObject)(entry.libEntry,_options2.default.baseName);var baseEntry=libEntry.filterObj;var newLibEntry=libEntry.newObj;var baseConfig={};var newConfig={};var _module={rules:[loaders.imageLoader('libs',_options2.default.imgName,_options2.default.imglimit),loaders.fontLoader('libs',_options2.default.fontName,_options2.default.fontlimit),loaders.mediaLoader('libs',_options2.default.mediaName)]};baseConfig=(0,_webpackMerge2.default)(config,{name:'base',entry:baseEntry,module:_module,plugins:[]});baseConfig.externals={};if(_options2.default.__ANALYZER__){baseConfig.plugins=baseConfig.plugins.concat(new _webpackBundleAnalyzer.BundleAnalyzerPlugin({analyzerPort:3997}));};libConfigs.push(baseConfig);newConfig=(0,_webpackMerge2.default)(config,{name:'libs',entry:newLibEntry,module:_module,plugins:[new _copyWebpackPlugin2.default(entry.onlyCopys)]});if(_options2.default.__ANALYZER__){newConfig.plugins=newConfig.plugins.concat(new _webpackBundleAnalyzer.BundleAnalyzerPlugin({analyzerPort:3998}));};libConfigs.push(newConfig);}// app 配置
var appConfig={};if(_options2.default.isBuildAllModule){appConfig=(0,_webpackMerge2.default)(config,{name:'app',entry:entry.appEntry['app'],module:{rules:[loaders.imageLoader('app',_options2.default.imgName,_options2.default.imglimit),loaders.fontLoader('app',_options2.default.fontName,_options2.default.imglimit),loaders.mediaLoader('app',_options2.default.mediaName)]},plugins:[new _esWebpack2.default.optimize.CommonsChunkPlugin({name:'app',filename:'app/js/'+_options2.default.commonsChunkFileName+'.js',chunks:Object.keys(entry.appEntry['app']),minChunks:minChunks}),new _chunkManifestWebpackPlugin2.default({filename:'app/chunk-manifest.json',manifestVariable:"webpackManifest"})]});if(_options2.default.__ANALYZER__){appConfig.plugins=appConfig.plugins.concat(new _webpackBundleAnalyzer.BundleAnalyzerPlugin({analyzerPort:3999}));};if((0,_utils.fsExistsSync)(_options2.default.globalDir+'/app/'+_options2.default.copyName)){appConfig.plugins=appConfig.plugins.concat(new _copyWebpackPlugin2.default([{from:_options2.default.globalDir+'/app/'+_options2.default.copyName,to:'app/'+_options2.default.copyName,toType:'dir'}]));}}// 通用配置 - 包括插件、bundle、主题
var commonConfigs=[];if(_options2.default.isBuildAllModule||_options2.default.buildModule.length){var commonEntry=entry.commonEntry;var commonEntryKeys=Object.keys(commonEntry);var index=0;commonEntryKeys.forEach(function(key){var commonConfig={};if((0,_utils.isEmptyObject)(commonEntry[key])){return;};commonConfig=(0,_webpackMerge2.default)(config,{name:''+key,entry:commonEntry[key],module:{rules:[loaders.imageLoader(key,_options2.default.imgName,_options2.default.imglimit),loaders.fontLoader(key,_options2.default.fontName,_options2.default.fontlimit),loaders.mediaLoader(key,_options2.default.mediaName)]},plugins:[]});var commonSrcEntry=entry.commonSrcEntry;if((0,_utils.fsExistsSync)(commonSrcEntry[key]+'/'+_options2.default.copyName)){commonConfig.plugins=commonConfig.plugins.concat(new _copyWebpackPlugin2.default([{from:commonSrcEntry[key]+'/'+_options2.default.copyName,to:key+'/'+_options2.default.copyName,toType:'dir'}]));}if((0,_utils.fsExistsSync)(commonSrcEntry[key]+'/'+_options2.default.isNeedCommonChunk)){commonConfig.plugins=commonConfig.plugins.concat(new _esWebpack2.default.optimize.CommonsChunkPlugin({name:key,filename:key+'/js/'+_options2.default.commonsChunkFileName+'.js',chunks:Object.keys(commonEntry[key]),minChunks:minChunks}),new _chunkManifestWebpackPlugin2.default({filename:key+'/chunk-manifest.json',manifestVariable:'webpackManifest'}));}if(_options2.default.__ANALYZER__){commonConfig.plugins=commonConfig.plugins.concat(new _webpackBundleAnalyzer.BundleAnalyzerPlugin({analyzerPort:'400'+index}));};commonConfigs.push(commonConfig);index++;});}// 总配置
var configs=[];[libConfigs,appConfig,commonConfigs].forEach(function(item){if(item.constructor===Object&&!(0,_utils.isEmptyObject)(item)){configs.push(item);}else if(item.constructor===Array&&item.length){configs=configs.concat(item);}});exports.default=configs;